<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>CSV checks - data_check</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CSV checks";
        var mkdocs_page_input_path = "csv_checks.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> data_check
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../install/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../databases/">Databases</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../usage/">Usage</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">CSV checks</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#sql-file">SQL file</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#templates">Templates</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#csv-format">CSV format</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#empty-dataset-checks">Empty dataset checks</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#full-table-checks">Full table checks</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#generating-expectation-files">Generating expectation files</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#lookups">Lookups</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-types">Data types</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../loading_data/">Loading data</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sql/">Running SQL</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pipelines/">Pipelines</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../test_data/">Test data</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../howtos/">HowTos</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../example/">Examples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../development/">Development</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">data_check</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>CSV checks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="csv-checks">CSV checks</h1>
<p>This is the default mode when running data_check. data_check expects a <a href="#sql-file">SQL file</a> and a <a href="#csv-format">CSV file</a>. The SQL file will be executed against the database and the result is compared with the CSV file. If they match, the test is passed, otherwise it fails.</p>
<h2 id="sql-file">SQL file</h2>
<p>Each SQL file must contain a single SQL query. The query will be executed in the database, hence you must use the SQL dialect that the database in use understands.</p>
<h3 id="templates">Templates</h3>
<p>SQL files can contain Jinja2 templates. The templates are replaced with the values defined in <em>checks/template.yml</em>. Example:</p>
<p>SQL file:</p>
<pre><code class="language-sql">select '{{template_value}}' as test
</code></pre>
<p><em>checks/template.yml</em>:</p>
<pre><code class="language-yaml">template_value: ABC
</code></pre>
<p>CSV file:</p>
<pre><code class="language-csv">test
ABC
</code></pre>
<h2 id="csv-format">CSV format</h2>
<p>data_check uses a basic CSV format. Each column is separated by a comma without any space around them.
The first line must contain a header. The columns must match the columns in the SQL file.</p>
<p>Any columns that do not match between the CSV and the SQL file will be ignored.</p>
<pre><code class="language-csv">string_header,int_header,float_header,date_header,null_header
string,42,42.1,2020-12-20,
# a comment line
&quot;second row&quot;,42,42.1,2020-12-20,
</code></pre>
<p>Anything after '#' is regarded as a comment. You can use comments to annotate the date as they will be completely ignored.
You can escape the start of the comment with '\' and threat the rest of the line as data.</p>
<p>Only the data types strings, decimals and date/timestamps (partially) are supported. Strings can be optionally enclosed in double quotes (").
Empty strings are treated as null values.</p>
<p>data_check recognizes if a column in a SQL query is a date or timestamp and converts the columns in the CSV automatically to timestamps.
For some databases (PostgreSQL, MySQL) this only works for timestamp/datetime columns, not date columns.
The date format in the CSV file must use <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>, for example "2021-12-30" or "2021-12-30 13:45:56".</p>
<p>Any other data type must be converted to strings/varchar in the SQL query.</p>
<h2 id="empty-dataset-checks">Empty dataset checks</h2>
<p>If you expect the result of the SQL query to be empty, you do not have to write a CSV file with the header. Instead, create a file with the ending <em>.empty</em>.
Since the column names do not matter, the check will pass, if the SQL query does not return any values.</p>
<p>The <em>.empty</em> file can be empty or contain any data. data_check does not read the content from this file.</p>
<p>Example:</p>
<pre><code>empty_query.sql
empty_query.empty
</code></pre>
<h2 id="full-table-checks">Full table checks</h2>
<p>To compare the content of a whole table, you can also put a CSV or Excel file without the SQL file. The file must be named after the table name. data_check will only compare the columns in the file. If the table does not have a column from the CSV/Excel header, the test will fail.</p>
<p>Example:</p>
<p><em>schema.table_name.csv</em>:</p>
<pre><code class="language-csv">column1,column2
data1,data2
...
</code></pre>
<p>This will run this SQL query: <code>select column1, column2 from schema.table_name</code> and compare the result against the CSV file.</p>
<h2 id="generating-expectation-files">Generating expectation files</h2>
<p>If you run <code>data_check gen</code> in a project folder, data_check will execute the query for each SQL file where the CSV file is missing and write the results into the CSV file. You can add <code>--force</code> to overwrite existing CSV files.</p>
<p>You can also generate expectation files for <a href="../pipelines/#generating-pipeline.checks">pipelines</a>. If you run <code>data_check gen</code> on a project with pipelines, beware though that the pipelines will be executed!</p>
<h2 id="lookups">Lookups</h2>
<p>Lookups are a way to reuse the result of a query in multiple other queries. You can use lookups for example to return all table names that you want to exclude from your tests and use the table names to filter them from your queries.</p>
<p>To create a lookup, put a SQL file in the <em>lookups</em> folder. To use the lookup in a query, use the lookup name like a subquery or list. The lookup name is the SQL filename prefixed with a colon (':') and without the file ending. If a lookup file is in subfolders, each subfolder is part of the lookup name with a double underscore ('__') as the separator between folders and the SQL filename.</p>
<p>Only the first column from a lookup query is used, other columns are ignored.</p>
<p>Example:</p>
<p><em>some_check.sql</em>:</p>
<pre><code class="language-sql">select a
from some_table
where b in :b1
 or a in :sub_lkp__b2
</code></pre>
<p><em>lookups/b1.sql</em>:</p>
<pre><code class="language-sql">select 'b' as b
union all
select 'c' as b

</code></pre>
<p><em>lookups/sub_lkp/b2.sql</em>:</p>
<pre><code class="language-sql">select 1 as b
union all
select 2 as b
</code></pre>
<p>In this example <code>:b1</code> is loaded from the file <em>lookups/b1.sql</em> and <code>:sub_lkp__b2</code> from <em>lookups/sub_lkp/b2.sql</em>.</p>
<h2 id="data-types">Data types</h2>
<p>data_check tries its best to match the data types from the SQL result with the data types from the CSV file.
There are, however, some edge cases where data_check has to convert the data types based on a heuristic:</p>
<p>If the SQL result or the CSV file have float64 values in a column, the column of the other part will also be converted to float64,
since float64 might be represented in scientific notation. If the conversion fails, the check will fail anyways.</p>
<p>If the SQL result or the CSV file have mixed string/numeric values in a column, data_check will convert the column to float64 if the other column has only float64 values. Otherwise it will convert both columns to string values.</p>
<p>In all other cases, if the matching columns have different data types, data_check will convert them to the string representation.</p>
<p>For date types, data_check is using internally the python datetime type. pandas Timestamp cannot be used here, since it has a lower <a href="https://pandas.pydata.org/docs/reference/api/pandas.Timestamp.max.html">limit</a> for dates than all the supported databases.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../usage/" class="btn btn-neutral float-left" title="Usage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../loading_data/" class="btn btn-neutral float-right" title="Loading data">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../usage/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../loading_data/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
