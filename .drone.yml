---
kind: pipeline
type: docker
name: oracle

platform:
  os: linux
  arch: amd64

steps:
- name: data_check
  pull: if-not-exists
  image: local/poetry_oracle
  commands:
  - cp -rn example/checks test/int_test/oracle
  - cp -rn example/load_data test/int_test/oracle
  - cp -rn example/run_sql test/int_test/oracle
  - cp -rn example/lookups test/int_test/oracle
  - poetry install -E oracle
  - cd test/int_test/oracle
  - bash -c 'while ! poetry run data_check --ping --quiet; do sleep 1; done'
  - poetry run data_check --sql-files prepare
  - poetry run pytest ../../../test/database
  - poetry run data_check --generate checks/generated
  - poetry run data_check checks/basic --traceback --print
  - poetry run data_check checks/generated --traceback --print
  - poetry run data_check checks/empty_sets/basic --traceback --print
  - poetry run data_check checks/excel/basic --traceback --print
  - poetry run data_check checks/pipelines/simple_pipeline --traceback --print
  - poetry run data_check checks/pipelines/date_test --traceback --print
  - poetry run data_check checks/pipelines/leading_zeros --traceback --print
  - bash -c 'if ! poetry run data_check checks/failing/duplicates.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/expected_to_fail.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid_csv.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/empty_sets/failing/not_empty_query.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_empty.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_excel.sql; then exit 0; else exit 1; fi'
  environment:
    LANG: en_US.utf-8
    LC_ALL: en_US.utf-8
    NLS_LANG: .utf8
    ORACLE_PWD: data_check

services:
- name: db
  image: oracle/database:18.4.0-xe
  settings:
    shm_size: 1gb
  environment:
    LANG: en_US.utf-8
    LC_ALL: en_US.utf-8
    NLS_LANG: .utf8
    ORACLE_PWD: data_check
  volumes:
  - name: oradata
    path: /opt/oracle/oradata

volumes:
- name: oradata
  host:
    path: /var/lib/oradata

---
kind: pipeline
type: docker
name: sqlite

platform:
  os: linux
  arch: amd64

steps:
- name: data_check
  pull: if-not-exists
  image: local/poetry:3.8
  commands:
  - cp -rn example/checks test/int_test/sqlite
  - cp -rn example/load_data test/int_test/sqlite
  - cp -rn example/run_sql test/int_test/sqlite
  - cp -rn example/lookups test/int_test/sqlite
  - poetry install
  - cd test/int_test/sqlite
  - bash -c 'while ! poetry run data_check --ping --quiet; do sleep 1; done'
  - poetry run data_check --sql-files prepare
  - poetry run pytest ../../../test/database
  - poetry run data_check --generate checks/generated
  - poetry run data_check checks/basic --traceback --print
  - poetry run data_check checks/generated --traceback --print
  - poetry run data_check checks/empty_sets/basic --traceback --print
  - poetry run data_check checks/excel/basic --traceback --print
  - poetry run data_check checks/pipelines/simple_pipeline --traceback --print
  - poetry run data_check checks/pipelines/date_test --traceback --print
  - poetry run data_check checks/pipelines/leading_zeros --traceback --print
  - bash -c 'if ! poetry run data_check checks/failing/duplicates.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/expected_to_fail.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid_csv.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/empty_sets/failing/not_empty_query.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_empty.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_excel.sql; then exit 0; else exit 1; fi'

---
kind: pipeline
type: docker
name: mysql

platform:
  os: linux
  arch: amd64

steps:
- name: data_check
  pull: if-not-exists
  image: local/poetry:3.8
  commands:
  - cp -rn example/checks test/int_test/mysql
  - cp -rn example/load_data test/int_test/mysql
  - cp -rn example/run_sql test/int_test/mysql
  - cp -rn example/lookups test/int_test/mysql
  - poetry install -E mysql
  - cd test/int_test/mysql
  - bash -c 'while ! poetry run data_check --ping --quiet; do sleep 1; done'
  - poetry run data_check --sql-files prepare
  - poetry run pytest ../../../test/database
  - poetry run data_check --generate checks/generated
  - poetry run data_check checks/basic --traceback --print
  - poetry run data_check checks/generated --traceback --print
  - poetry run data_check checks/empty_sets/basic --traceback --print
  - poetry run data_check checks/excel/basic --traceback --print
  - poetry run data_check checks/pipelines/simple_pipeline --traceback --print
  - poetry run data_check checks/pipelines/date_test --traceback --print
  - poetry run data_check checks/pipelines/leading_zeros --traceback --print
  - bash -c 'if ! poetry run data_check checks/failing/duplicates.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/expected_to_fail.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid_csv.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/empty_sets/failing/not_empty_query.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_empty.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_excel.sql; then exit 0; else exit 1; fi'
  environment:
    MYSQL_ROOT_PASSWORD: data_check

services:
- name: db
  image: mysql:8
  environment:
    MYSQL_ROOT_PASSWORD: data_check

---
kind: pipeline
type: docker
name: postgres

platform:
  os: linux
  arch: amd64

steps:
- name: data_check
  pull: if-not-exists
  image: local/poetry:3.8
  commands:
  - cp -rn example/checks test/int_test/postgres
  - cp -rn example/load_data test/int_test/postgres
  - cp -rn example/run_sql test/int_test/postgres
  - cp -rn example/lookups test/int_test/postgres
  - poetry install -E postgres
  - cd test/int_test/postgres
  - bash -c 'while ! poetry run data_check --ping --quiet; do sleep 1; done'
  - poetry run data_check --sql-files prepare
  - poetry run pytest ../../../test/database
  - poetry run data_check --generate checks/generated
  - poetry run data_check checks/basic --traceback --print
  - poetry run data_check checks/generated --traceback --print
  - poetry run data_check checks/empty_sets/basic --traceback --print
  - poetry run data_check checks/excel/basic --traceback --print
  - poetry run data_check checks/pipelines/simple_pipeline --traceback --print
  - poetry run data_check checks/pipelines/date_test --traceback --print
  - poetry run data_check checks/pipelines/leading_zeros --traceback --print
  - bash -c 'if ! poetry run data_check checks/failing/duplicates.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/expected_to_fail.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid_csv.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/empty_sets/failing/not_empty_query.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_empty.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_excel.sql; then exit 0; else exit 1; fi'
  environment:
    POSTGRES_PASSWORD: data_check

services:
- name: db
  image: postgres:13
  environment:
    POSTGRES_PASSWORD: data_check

---
kind: pipeline
type: docker
name: mssql

platform:
  os: linux
  arch: amd64

steps:
- name: data_check
  pull: if-not-exists
  image: local/poetry_mssql
  commands:
  - cp -rn example/checks test/int_test/mssql
  - cp -rn example/load_data test/int_test/mssql
  - cp -rn example/run_sql test/int_test/mssql
  - cp -rn example/lookups test/int_test/mssql
  - poetry install -E mssql
  - cd test/int_test/mssql
  - bash -c 'while ! poetry run data_check --ping --quiet; do sleep 1; done'
  - poetry run data_check --sql-files prepare
  - poetry run pytest ../../../test/database
  - poetry run data_check --generate checks/generated
  - poetry run data_check checks/basic --traceback --print
  - poetry run data_check checks/generated --traceback --print
  - poetry run data_check checks/empty_sets/basic --traceback --print
  - poetry run data_check checks/excel/basic --traceback --print
  - poetry run data_check checks/pipelines/simple_pipeline --traceback --print
  - poetry run data_check checks/pipelines/date_test --traceback --print
  - poetry run data_check checks/pipelines/leading_zeros --traceback --print
  - bash -c 'if ! poetry run data_check checks/failing/duplicates.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/expected_to_fail.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid_csv.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/failing/invalid.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/empty_sets/failing/not_empty_query.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_empty.sql; then exit 0; else exit 1; fi'
  - bash -c 'if ! poetry run data_check checks/excel/failing/failing_excel.sql; then exit 0; else exit 1; fi'
  environment:
    ACCEPT_EULA: Y
    MSSQL_PID: Express
    SA_PASSWORD: data_CHECK

services:
- name: db
  image: mcr.microsoft.com/mssql/server:2019-latest
  environment:
    ACCEPT_EULA: Y
    MSSQL_PID: Express
    SA_PASSWORD: data_CHECK

...
